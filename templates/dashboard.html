<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>æ™ºæ…§æ ¡å›­è¯¾å®¤é¢„çº¦ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cell-free { background-color: #d1fae5; cursor: pointer; } 
        .cell-free:hover { background-color: #34d399; }
        .cell-sunday { background-color: #bfdbfe; cursor: not-allowed; } 
        .cell-course { background-color: #fca5a5; color: #7f1d1d; font-weight: bold; cursor: pointer; } 
        .cell-taken { background-color: #fde047; cursor: pointer; } 
        .cell-pending { background-color: #e5e7eb; cursor: help; } 
        .drawer { transition: transform 0.3s ease-in-out; transform: translateX(100%); }
        .drawer.open { transform: translateX(0); }
    </style>
</head>
<body class="bg-gray-100 p-4 h-screen flex flex-col">

<script>
    let isAdminLoggedIn = false;

    window.onload = function() {
        const urlParams = new URLSearchParams(window.location.search);
        const msg = urlParams.get('msg');
        const roleParam = urlParams.get('role'); 

        // è‡ªåŠ¨æ¢å¤èº«ä»½
        if (roleParam === 'admin') {
            isAdminLoggedIn = true;
            const roleSelect = document.getElementById('role-switch');
            if (roleSelect) {
                roleSelect.value = 'admin';
                updateUIForRole(); 
            }
        }

        if (msg === 'submitted') {
            alert("âœ… ç”³è¯·å·²æäº¤ï¼è¯·ç­‰å¾…åŠ©ç†å®¡æ ¸ç»“æœã€‚");
        } else if (msg === 'audit_done') {
            alert("âœ… æ“ä½œå®Œæˆï¼(å¦‚æœ‰å¿…è¦ç³»ç»Ÿå·²è‡ªåŠ¨å‘é€é‚®ä»¶é€šçŸ¥å­¦ç”Ÿ)");
        } else if (msg === 'course_added') {
            alert("âœ… è¯¾ç¨‹æ’è¯¾æˆåŠŸï¼");
        } else if (msg === 'error_conflict') {
            alert("âŒ æ‰‹æ…¢äº†ï¼è¯¥æ—¶æ®µåˆšåˆšå·²è¢«å ç”¨ã€‚");
        }
    }
</script>

<div class="flex justify-between items-center mb-4 bg-white p-4 shadow rounded shrink-0">
    <div class="flex items-center space-x-4">
        <h1 class="text-2xl font-bold text-gray-800">ğŸ“… è¯¾å®¤èµ„æºçœ‹æ¿</h1>
        <div class="space-x-2 text-sm">
            <span class="px-2 py-1 bg-green-200 rounded">ğŸŸ© å¯é¢„çº¦</span>
            <span class="px-2 py-1 bg-red-200 rounded">ğŸŸ¥ è¯¾ç¨‹/å ç”¨</span>
            <span class="px-2 py-1 bg-yellow-200 rounded">ğŸŸ¨ å·²é¢„çº¦</span>
            <span class="px-2 py-1 bg-gray-200 rounded">â¬œ å¾…å®¡æ ¸</span>
        </div>
    </div>
    <div class="flex items-center space-x-2">
        <a href="/?view_date={{ prev_week }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">â¬…ï¸ ä¸Šå‘¨</a>
        <span class="font-bold text-lg">{{ current_week_start }} è‡³ {{ next_week }}</span>
        <a href="/?view_date={{ next_week }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">ä¸‹å‘¨ â¡ï¸</a>
    </div>
    <div>
        <label class="mr-2 font-bold">å½“å‰èº«ä»½:</label>
        <select id="role-switch" onchange="handleRoleChange()" class="border p-1 rounded bg-blue-50 font-bold text-blue-800">
            <option value="student">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿ</option>
            <option value="admin">ğŸ‘©â€ğŸ’¼ åŠ©ç† (éœ€è¦å¯†ç )</option>
        </select>
    </div>
</div>

<div class="flex-grow overflow-auto bg-white shadow rounded-lg mb-4 relative">
    <table class="min-w-full border-collapse border border-gray-300 text-sm text-center">
        <thead class="bg-gray-800 text-white sticky top-0 z-10">
            <tr>
                <th class="p-2 border">å‘¨æ¬¡</th><th class="p-2 border">æ—¥æœŸ</th><th class="p-2 border">æ˜ŸæœŸ</th><th class="p-2 border">èŠ‚æ¬¡</th>
                {% for room in rooms %}<th class="p-2 border w-40">{{ room.name }}</th>{% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in dashboard_rows %}
            <tr class="border-b">
                <td class="p-2 border bg-gray-50">{{ row.week }}</td>
                <td class="p-2 border bg-gray-50">{{ row.date }}</td>
                <td class="p-2 border bg-gray-50 font-bold {{ 'text-blue-600' if row.is_sunday else '' }}">{{ row.weekday }}</td>
                <td class="p-2 border bg-gray-50">{{ row.slot }}</td>
                {% for cell in row.cells %}
                <td class="border p-1 h-16 align-middle transition duration-150
                           {% if cell.status == 'FREE' %} cell-free
                           {% elif cell.status == 'SUNDAY' %} cell-sunday
                           {% elif cell.status == 'COURSE' %} cell-course
                           {% elif cell.status == 'TAKEN' %} cell-taken
                           {% else %} cell-pending {% endif %}"
                    
                    data-status="{{ cell.status }}"
                    data-room-id="{{ cell.room_id }}"
                    data-date="{{ row.date }}"
                    data-slot="{{ row.slot }}"
                    data-booking-id="{{ cell.booking.id if cell.booking else '' }}"
                    data-student="{{ cell.booking.student_name if cell.booking else '' }}"
                    data-student-id="{{ cell.booking.student_id if cell.booking else '' }}"
                    data-email="{{ cell.booking.student_email if cell.booking else '' }}"
                    data-teacher="{{ cell.booking.instructor_name if cell.booking else '' }}"
                    data-purpose="{{ cell.booking.purpose if cell.booking else '' }}"
                    
                    onclick="handleCellClick(this)"
                >
                    {% if cell.status == 'COURSE' %}
                        {{ cell.booking.student_name }}<br><span class="text-xs">{{ cell.booking.instructor_name }}</span>
                    {% elif cell.status == 'TAKEN' %}
                        å·²é¢„çº¦<br><span class="text-xs text-gray-600">{{ cell.booking.student_name }}</span>
                    {% elif cell.status == 'PENDING' %}
                        <span class="text-gray-500 font-bold">å®¡æ ¸ä¸­</span>
                    {% elif cell.status == 'FREE' %}
                        <span class="text-green-600 font-bold opacity-0 hover:opacity-100 text-lg">+</span>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<button onclick="toggleDrawer()" class="admin-only hidden fixed bottom-8 right-8 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 z-50 flex items-center">
    ğŸ“‹ ç®¡ç†ç”³è¯· <span class="ml-2 bg-red-500 text-white text-xs rounded-full px-2">{{ pending_list|length }}</span>
</button>

<div id="audit-drawer" class="drawer fixed inset-y-0 right-0 w-96 bg-white shadow-2xl z-50 border-l border-gray-200 overflow-y-auto">
    <div class="p-4 bg-gray-100 flex justify-between items-center sticky top-0 border-b">
        <h2 class="text-xl font-bold">ğŸ“ é¢„çº¦ç®¡ç†ä¸­å¿ƒ</h2>
        <button onclick="toggleDrawer()" class="text-gray-500 text-2xl hover:text-red-500">&times;</button>
    </div>
    
    <div class="p-4">
        <div class="flex space-x-4 mb-4 border-b">
            <button onclick="showTab('pending')" id="btn-pending" class="pb-2 font-bold border-b-2 border-blue-500 text-blue-600 w-1/2">å¾…å®¡æ ¸</button>
            <button onclick="showTab('approved')" id="btn-approved" class="pb-2 text-gray-500 hover:text-gray-800 w-1/2">å·²é€šè¿‡è®°å½•</button>
        </div>

        <div id="tab-pending" class="space-y-4">
            {% for item in pending_list %}
            <div class="bg-white p-4 rounded-lg border shadow-sm hover:shadow-md transition">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="font-bold text-lg text-gray-800">{{ item.student_name }}</span>
                        <span class="text-xs text-gray-500 block">å­¦å·: {{ item.student_id }}</span>
                    </div>
                    <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">{{ item.booking_date.strftime('%m-%d') }}</span>
                </div>
                
                <div class="text-sm text-gray-600 space-y-1 mb-3 bg-gray-50 p-3 rounded">
                    <p><span class="font-bold text-gray-500">åœ°ç‚¹ï¼š</span>{{ item.room.name }}</p>
                    <p><span class="font-bold text-gray-500">æ—¶é—´ï¼š</span>{{ item.slot.value }}</p>
                    <p><span class="font-bold text-gray-500">è€å¸ˆï¼š</span>{{ item.instructor_name or 'æ— ' }}</p>
                    <p><span class="font-bold text-gray-500">ç”¨é€”ï¼š</span>{{ item.purpose }}</p>
                    <p><span class="font-bold text-gray-500">é‚®ç®±ï¼š</span>{{ item.student_email }}</p>
                </div>

                <div class="flex space-x-2">
                    <form action="/audit/{{ item.id }}" method="post" class="flex-1">
                        <input type="hidden" name="action" value="approve">
                        <button class="w-full bg-green-500 text-white py-2 rounded font-bold hover:bg-green-600">é€šè¿‡</button>
                    </form>
                    <button onclick="openCancelModal('{{ item.id }}', 'reject', 'reject')" class="flex-1 bg-red-500 text-white py-2 rounded font-bold hover:bg-red-600">é©³å›</button>
                </div>
            </div>
            {% else %}
            <div class="text-center text-gray-400 py-8"><p>æš‚æ— å¾…å®¡æ ¸ç”³è¯·</p></div>
            {% endfor %}
        </div>

        <div id="tab-approved" class="space-y-4 hidden">
            {% for item in approved_list %}
            <div class="bg-white p-4 rounded-lg border border-l-4 border-l-yellow-400 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                    <span class="font-bold text-gray-800">
                        {% if item.booking_type == 'course' %} 
                            ğŸ“˜ [è¯¾ç¨‹] {{ item.student_name }} 
                        {% else %} 
                            ğŸ‘¤ {{ item.student_name }} ({{ item.student_id }}) 
                        {% endif %}
                    </span>
                </div>
                <div class="text-sm text-gray-600 space-y-1 mb-3">
                    <p><strong>æ—¥æœŸ:</strong> {{ item.booking_date }}</p>
                    <p><strong>æ—¶é—´:</strong> {{ item.slot.value }}</p> 
                    <p><strong>åœ°ç‚¹:</strong> {{ item.room.name }}</p>
                    <p><strong>è€å¸ˆ:</strong> {{ item.instructor_name or '-' }}</p>
                </div>
                
                {% if item.booking_type == 'course' %}
                    <button onclick="openCancelModal('{{ item.id }}', 'delete', 'course_delete')" class="w-full bg-gray-100 text-gray-600 py-1 rounded text-sm hover:bg-red-50 hover:text-red-600 border border-gray-200">
                        âŒ å–æ¶ˆæ’è¯¾
                    </button>
                {% else %}
                    <button onclick="openCancelModal('{{ item.id }}', 'delete', 'student_delete')" class="w-full bg-gray-100 text-gray-600 py-1 rounded text-sm hover:bg-red-50 hover:text-red-600 border border-gray-200">
                        âŒ å¼ºåˆ¶å–æ¶ˆ
                    </button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div id="cancel-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-96 border-t-4 border-red-500">
        <h2 class="text-xl font-bold mb-4 text-gray-800" id="cancel-title">âš ï¸ ç¡®è®¤æ“ä½œ</h2>
        <form id="cancel-form" action="" method="post">
            <input type="hidden" name="action" id="cancel-action-input">
            <label class="block font-bold text-sm mb-2 text-gray-700">è¯·é€‰æ‹©åŸå› :</label>
            <select name="cancel_reason" id="cancel-reason-select" class="w-full border p-2 rounded mb-6 bg-gray-50">
            </select>
            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closeModal('cancel-modal')" class="px-4 py-2 bg-gray-200 rounded">æš‚ä¸å–æ¶ˆ</button>
                <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">ç¡®è®¤æäº¤</button>
            </div>
        </form>
    </div>
</div>

<div id="detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50"><div class="bg-white p-6 rounded-xl shadow-2xl w-96"><h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">ğŸ“Œ é¢„çº¦è¯¦ç»†æ¡£æ¡ˆ</h2><div class="space-y-3 mb-6 text-sm text-gray-600"><div><span class="block text-xs text-gray-400">ç”³è¯·äºº/è¯¾ç¨‹</span><span id="detail-name" class="text-gray-900 font-bold text-lg block"></span></div><div class="grid grid-cols-2 gap-2"><div><span class="block text-xs text-gray-400">å­¦å·/ID</span><span id="detail-student-id" class="text-gray-800 font-mono"></span></div><div><span class="block text-xs text-gray-400">æŒ‡å¯¼/ä»»è¯¾è€å¸ˆ</span><span id="detail-teacher" class="text-gray-800"></span></div></div><div><span class="block text-xs text-gray-400">è”ç³»é‚®ç®±</span><span id="detail-email" class="text-blue-600 underline"></span></div><div class="bg-gray-50 p-2 rounded"><span class="block text-xs text-gray-400">ç”¨é€”</span><span id="detail-purpose" class="text-gray-800"></span></div><div class="text-xs text-gray-400 mt-2 pt-2 border-t">æ—¶é—´: <span id="detail-time"></span></div></div><div class="flex justify-end space-x-2"><button type="button" onclick="closeModal('detail-modal')" class="px-4 py-2 bg-gray-200 rounded">å…³é—­</button><button id="btn-force-cancel" onclick="" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">ğŸ—‘ï¸ å¼ºåˆ¶å–æ¶ˆ</button></div></div></div>
<div id="student-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-40"><div class="bg-white p-6 rounded-xl shadow-2xl w-[500px]"><h2 class="text-xl font-bold mb-4 text-blue-600">ğŸ“ å­¦ç”Ÿé¢„çº¦ç”³è¯·</h2><form action="/submit_booking" method="post"><input type="hidden" name="mode" value="student"><input type="hidden" name="room_id" id="stu-room-id"><input type="hidden" name="booking_date" id="stu-date"><input type="hidden" name="slot" id="stu-slot"><div class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold text-gray-700">å­¦å·</label><input type="text" name="student_id" placeholder="å­¦å·" required class="w-full border p-2 rounded"></div><div><label class="block text-sm font-bold text-gray-700">å§“å</label><input type="text" name="student_name" placeholder="å§“å" required class="w-full border p-2 rounded"></div></div><div><label class="block text-sm font-bold text-gray-700">æŒ‡å¯¼è€å¸ˆ</label><input type="text" name="instructor_name" placeholder="æŒ‡å¯¼è€å¸ˆå§“å" class="w-full border p-2 rounded"></div><div><label class="block text-sm font-bold text-gray-700">è”ç³»é‚®ç®±</label><input type="email" name="student_email" placeholder="é‚®ç®±" required class="w-full border p-2 rounded"></div><div><label class="block text-sm font-bold text-gray-700">ç”³è¯·ç”¨é€”</label><input type="text" name="purpose" placeholder="ç”¨é€”" required class="w-full border p-2 rounded"></div></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('student-modal')" class="px-4 py-2 bg-gray-200 rounded">å–æ¶ˆ</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">æäº¤</button></div></form></div></div>
<div id="admin-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-40"><div class="bg-white p-6 rounded-xl shadow-2xl w-[600px] border-t-4 border-red-500"><h2 class="text-xl font-bold mb-4 text-red-600">ğŸ‘©â€ğŸ’¼ åŠ©ç†æ’è¯¾ (æ‰¹é‡)</h2><form action="/submit_booking" method="post"><input type="hidden" name="mode" value="course"><input type="hidden" name="room_id" id="adm-room-id"><input type="hidden" name="booking_date" id="adm-date"><div class="space-y-4"><div class="grid grid-cols-2 gap-4"><div><label class="block font-bold text-sm">è¯¾ç¨‹åç§°</label><input type="text" name="course_name" placeholder="å¦‚ï¼šPythonç¨‹åºè®¾è®¡" required class="w-full border p-2 rounded"></div><div><label class="block font-bold text-sm">ä»»è¯¾è€å¸ˆ</label><input type="text" name="course_teacher" placeholder="å¦‚ï¼šç‹è€å¸ˆ" required class="w-full border p-2 rounded"></div></div><div class="bg-red-50 p-3 rounded border border-red-100"><label class="block font-bold text-sm mb-2 text-red-800">ğŸ“… å¾ªç¯ä¸Šè¯¾å‘¨æ¬¡ (é»˜è®¤1-16å‘¨)</label><div class="flex items-center space-x-2"><span>ç¬¬</span><input type="number" name="start_week" value="1" min="1" max="20" class="border p-1 w-16 text-center rounded"><span>å‘¨  è‡³  ç¬¬</span><input type="number" name="end_week" value="16" min="1" max="20" class="border p-1 w-16 text-center rounded"><span>å‘¨</span></div></div><div><label class="block font-bold text-sm mb-2">é€‰æ‹©ä¸Šè¯¾èŠ‚æ¬¡</label><div class="grid grid-cols-2 gap-2 bg-gray-50 p-3 rounded">{% for s in slots_list %}<label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-100 p-1 rounded"><input type="checkbox" name="slot" value="{{ s.value }}" class="w-5 h-5 text-red-600"><span>{{ s.value }}</span></label>{% endfor %}</div></div></div><div class="flex justify-end space-x-2 mt-6"><button type="button" onclick="closeModal('admin-modal')" class="px-4 py-2 bg-gray-200 rounded">å–æ¶ˆ</button><button type="submit" class="px-4 py-2 bg-red-600 text-white rounded">ç¡®è®¤æ·»åŠ </button></div></form></div></div>
<div id="password-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 hidden flex items-center justify-center z-[60]"><div class="bg-white p-8 rounded-xl shadow-2xl w-96 text-center"><div class="mb-4 text-4xl">ğŸ”</div><h2 class="text-xl font-bold mb-4 text-gray-800">åŠ©ç†ç«¯ç™»å½•</h2><input type="password" id="admin-password-input" placeholder="è¯·è¾“å…¥å¯†ç  (123456)" class="w-full border p-3 rounded mb-4 text-center text-lg tracking-widest focus:ring-2 focus:ring-blue-500 outline-none" onkeydown="if(event.key === 'Enter') verifyPassword()"><div class="flex justify-center space-x-3"><button onclick="cancelLogin()" class="px-6 py-2 bg-gray-200 rounded hover:bg-gray-300">å–æ¶ˆ</button><button onclick="verifyPassword()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold">ç™»å½•</button></div></div></div>

<script>
    // JS é€»è¾‘ä¿æŒä¸å˜
    function handleRoleChange() {
        const role = document.getElementById('role-switch').value;
        if (role === 'admin') {
            if (!isAdminLoggedIn) {
                document.getElementById('password-modal').classList.remove('hidden');
                document.getElementById('admin-password-input').value = '';
                document.getElementById('admin-password-input').focus();
                document.getElementById('role-switch').value = 'student'; 
            } else { updateUIForRole(); }
        } else { updateUIForRole(); }
    }
    function verifyPassword() {
        const pwd = document.getElementById('admin-password-input').value;
        const formData = new FormData(); formData.append('password', pwd);
        fetch('/api/validate_password', {method: 'POST', body: formData}).then(r=>r.json()).then(d=>{
            if(d.valid){ isAdminLoggedIn=true; document.getElementById('password-modal').classList.add('hidden'); document.getElementById('role-switch').value='admin'; updateUIForRole(); }
            else{ alert("âŒ å¯†ç é”™è¯¯"); document.getElementById('admin-password-input').value=''; }
        });
    }
    function cancelLogin() { document.getElementById('password-modal').classList.add('hidden'); document.getElementById('role-switch').value='student'; }
    function updateUIForRole() { const role = document.getElementById('role-switch').value; document.querySelectorAll('.admin-only').forEach(el => el.style.display = (role === 'admin') ? 'flex' : 'none'); }

    // åŠ¨æ€é€‰é¡¹é€»è¾‘
    function openCancelModal(bookingId, actionType, scenario) {
        document.getElementById('cancel-modal').classList.remove('hidden');
        document.getElementById('cancel-form').action = "/audit/" + bookingId;
        document.getElementById('cancel-action-input').value = actionType;
        
        const select = document.getElementById('cancel-reason-select');
        const title = document.getElementById('cancel-title');
        select.innerHTML = ''; 

        let options = [];
        if (scenario === 'reject') {
            title.innerText = "âš ï¸ ç¡®è®¤é©³å›ç”³è¯·";
            options = ["æœ¬äººå¡«å†™ä¿¡æ¯æœ‰è¯¯", "é¢„çº¦è¯·æ±‚å’Œå­¦é™¢å…¶å®ƒæ´»åŠ¨å†²çª"];
        } else if (scenario === 'course_delete') {
            title.innerText = "âš ï¸ ç¡®è®¤å–æ¶ˆè¯¾ç¨‹";
            options = ["æ•™å¸ˆéœ€è¦è°ƒè¯¾", "ä¸Šè¯¾åœºæ‰€å’Œå…¶å®ƒå®‰æ’å†²çª"];
        } else {
            title.innerText = "âš ï¸ ç¡®è®¤å–æ¶ˆé¢„çº¦";
            options = ["æœ¬äººè‡ªæ„¿ç”³è¯·å–æ¶ˆ", "ä¸å…¶å®ƒæ´»åŠ¨è¯¾ç¨‹å†²çª"];
        }

        options.forEach(opt => {
            const el = document.createElement('option');
            el.value = opt; el.innerText = opt; select.appendChild(el);
        });
        closeModal('detail-modal');
    }

    function handleCellClick(el) {
        const status = el.dataset.status;
        const role = document.getElementById('role-switch').value;
        const bookingId = el.dataset.bookingId;
        if (status === 'SUNDAY') return alert("ğŸ›‘ å‘¨æ—¥ä¼‘æ¯ã€‚");
        if (role === 'admin' && (status === 'TAKEN' || status === 'COURSE')) {
            document.getElementById('detail-modal').classList.remove('hidden');
            document.getElementById('detail-name').innerText = el.dataset.student;
            document.getElementById('detail-student-id').innerText = el.dataset.studentId || 'N/A';
            document.getElementById('detail-teacher').innerText = el.dataset.teacher || 'æ— ';
            document.getElementById('detail-email').innerText = el.dataset.email || 'æ— ';
            document.getElementById('detail-purpose').innerText = el.dataset.purpose || 'æ— ';
            document.getElementById('detail-time').innerText = el.dataset.date + " " + el.dataset.slot;
            
            const isCourse = (status === 'COURSE');
            const scenario = isCourse ? 'course_delete' : 'student_delete';
            document.getElementById('btn-force-cancel').onclick = function() { openCancelModal(bookingId, 'delete', scenario); };
            return;
        }
        if (role === 'admin') {
            if (status === 'FREE') openAdminModal(el.dataset.roomId, el.dataset.date);
            else if (status === 'PENDING') alert("ğŸ‘‡ è¯·åœ¨å³ä¸‹è§’ä¾§è¾¹æ å®¡æ ¸æ­¤ç”³è¯·ã€‚");
        } else {
            if (status === 'FREE') openStudentModal(el.dataset.roomId, el.dataset.date, el.dataset.slot);
            else alert("âš ï¸ è¯¥æ—¶æ®µä¸å¯ç”¨ã€‚");
        }
    }
    function openStudentModal(r, d, s) { document.getElementById('student-modal').classList.remove('hidden'); document.getElementById('stu-room-id').value = r; document.getElementById('stu-date').value = d; document.getElementById('stu-slot').value = s; }
    function openAdminModal(r, d) { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('adm-room-id').value = r; document.getElementById('adm-date').value = d; document.querySelectorAll('#admin-modal input[type="checkbox"]').forEach(cb => cb.checked = false); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function toggleDrawer() { document.getElementById('audit-drawer').classList.toggle('open'); }
    function showTab(tabName) {
        const btnPending = document.getElementById('btn-pending'); const btnApproved = document.getElementById('btn-approved');
        if (tabName === 'pending') { document.getElementById('tab-pending').classList.remove('hidden'); document.getElementById('tab-approved').classList.add('hidden'); btnPending.classList.add('border-b-2', 'border-blue-500', 'text-blue-600'); btnPending.classList.remove('text-gray-500'); btnApproved.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600'); btnApproved.classList.add('text-gray-500'); }
        else { document.getElementById('tab-pending').classList.add('hidden'); document.getElementById('tab-approved').classList.remove('hidden'); btnApproved.classList.add('border-b-2', 'border-blue-500', 'text-blue-600'); btnApproved.classList.remove('text-gray-500'); btnPending.classList.remove('border-b-2', 'border-blue-500', 'text-blue-600'); btnPending.classList.add('text-gray-500'); }
    }
    updateUIForRole();
</script>

</body>
</html>
