<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCNU IBC SAC æ™ºèƒ½é¢„çº¦ç³»ç»Ÿ | Smart Booking</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --ease-out: cubic-bezier(.16,1,.3,1);
      --ease-in: cubic-bezier(.7,0,.84,0);
      --shadow-card: 0 12px 40px rgba(2,6,23,.10);
    }
    @keyframes shimmer { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
    @keyframes pop { 0%{transform:scale(.98); opacity:0} 100%{transform:scale(1); opacity:1} }
    @keyframes slideUp { 0%{transform:translateY(18px); opacity:0} 100%{transform:translateY(0); opacity:1} }
    @keyframes slideInRight { 0%{transform:translateX(24px); opacity:0} 100%{transform:translateX(0); opacity:1} }
    @keyframes fadeOut { 0%{opacity:1} 100%{opacity:0} }

    .glass{ background: rgba(255,255,255,.70); border: 1px solid rgba(148,163,184,.25); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); }
    .card{ box-shadow: var(--shadow-card); border: 1px solid rgba(148,163,184,.22); }
    .btn{ transition: transform .18s var(--ease-out), box-shadow .18s var(--ease-out), filter .18s var(--ease-out); }
    .btn:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    .btn:active{ transform: translateY(0) scale(.99); }

    .cell{ position: relative; transition: transform .18s var(--ease-out), box-shadow .18s var(--ease-out); border-radius: 14px; overflow:hidden; }
    .cell::after{
      content:""; position:absolute; inset:0;
      background: radial-gradient(600px circle at var(--mx,50%) var(--my,50%), rgba(255,255,255,.22), transparent 35%);
      opacity:0; transition: opacity .18s var(--ease-out); pointer-events:none;
    }
    .cell:hover::after{ opacity:1; }

    .cell-free { background: linear-gradient(135deg, rgba(16,185,129,.18), rgba(59,130,246,.10)); cursor: pointer; }
    .cell-sunday { background: linear-gradient(135deg, rgba(59,130,246,.16), rgba(99,102,241,.10)); cursor: not-allowed; filter:saturate(.85); }
    .cell-course { background: linear-gradient(135deg, rgba(244,63,94,.22), rgba(251,113,133,.12)); color: #7f1d1d; font-weight: 700; cursor: pointer; }
    .cell-taken { background: linear-gradient(135deg, rgba(250,204,21,.22), rgba(253,224,71,.10)); cursor: pointer; }
    .cell-pending { background: linear-gradient(135deg, rgba(148,163,184,.22), rgba(241,245,249,.65)); cursor: help; }

    .drawer { transition: transform .42s var(--ease-out); transform: translateX(110%); }
    .drawer.open { transform: translateX(0); }

    .toast-enter{ animation: slideInRight .28s var(--ease-out) both; }
    .toast-exit{ animation: fadeOut .20s var(--ease-in) both; }

    .welcome-bg{
      background: radial-gradient(1200px circle at 20% 10%, rgba(99,102,241,.20), transparent 45%),
                  radial-gradient(900px circle at 85% 15%, rgba(236,72,153,.18), transparent 45%),
                  radial-gradient(900px circle at 70% 90%, rgba(16,185,129,.18), transparent 50%),
                  linear-gradient(180deg, rgba(2,6,23,.03), rgba(2,6,23,.00));
    }
    .welcome-orb{
      background: linear-gradient(135deg, rgba(99,102,241,.55), rgba(236,72,153,.50), rgba(16,185,129,.45));
      background-size: 200% 200%;
      animation: shimmer 7s var(--ease-out) infinite;
      opacity:.35;
    }
    .appear{ animation: pop .34s var(--ease-out) both; }
    .appear-up{ animation: slideUp .42s var(--ease-out) both; }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900 selection:bg-indigo-200/60">

  <!-- Toast -->
  <div id="toast-root" class="fixed top-5 right-5 z-[80] space-y-3"></div>

  <!-- Welcome -->
  <div id="welcome-screen" class="fixed inset-0 z-[70] welcome-bg">
    <div class="absolute inset-0 pointer-events-none">
      <div class="absolute -top-24 -left-24 w-[520px] h-[520px] rounded-full welcome-orb"></div>
      <div class="absolute -bottom-32 -right-32 w-[560px] h-[560px] rounded-full welcome-orb"></div>
    </div>

    <div class="relative mx-auto max-w-6xl px-6 py-10">
      <div class="flex items-center justify-between appear">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-indigo-600 to-pink-500 shadow-lg shadow-indigo-600/20 grid place-items-center text-white font-black">
            SAC
          </div>
          <div class="leading-tight">
            <div class="font-semibold tracking-tight">SCNU Â· IBC Â· SAC</div>
            <div class="text-xs text-slate-500">Smart Classroom Booking System</div>
          </div>
        </div>
        <div class="hidden md:flex items-center gap-2 text-xs text-slate-500">
          <span class="px-3 py-1 rounded-full glass">Bilingual UI</span>
          <span class="px-3 py-1 rounded-full glass">Motion</span>
          <span class="px-3 py-1 rounded-full glass">FastAPI</span>
        </div>
      </div>

      <div class="mt-10 grid grid-cols-1 lg:grid-cols-12 gap-8 items-stretch">
        <div class="lg:col-span-7 appear-up">
          <div class="glass card rounded-3xl p-8">
            <div class="text-sm text-slate-500 mb-2">æ™šä¸Šå¥½ / Good evening</div>
            <h1 class="text-3xl md:text-4xl font-black tracking-tight leading-tight">
              åå—å¸ˆèŒƒå¤§å­¦å›½é™…å•†å­¦é™¢å®åˆ›ä¸­å¿ƒ<br/>
              <span class="bg-gradient-to-r from-indigo-600 via-pink-500 to-emerald-500 bg-clip-text text-transparent">
                æ™ºèƒ½è¯¾å®¤é¢„çº¦ç³»ç»Ÿ
              </span>
              <span class="block text-base md:text-lg font-semibold text-slate-600 mt-2">
                SCNU IBC SAC Smart Classroom Booking System
              </span>
            </h1>

            <p class="mt-4 text-slate-600 leading-relaxed">
              çœ‹æ¿å¼èµ„æºå¯è§†åŒ– + ä¸€é”®é¢„çº¦ + ç®¡ç†å‘˜å®¡æ ¸/æ’è¯¾ï¼Œæå‡è¯¾å®¤èµ„æºåˆ©ç”¨æ•ˆç‡ä¸ç®¡ç†ä½“éªŒã€‚
            </p>

            <div class="mt-7 flex flex-col sm:flex-row gap-3">
              <button onclick="enterStudentFromWelcome()"
                      class="btn rounded-2xl px-6 py-3 font-semibold text-white bg-gradient-to-r from-indigo-600 to-pink-500 shadow-lg shadow-indigo-600/20">
                æˆ‘è¦é¢„çº¦ Â· Book Now
              </button>

              <button onclick="enterAdminFromWelcome()"
                      class="btn rounded-2xl px-6 py-3 font-semibold text-slate-800 bg-white/80 border border-slate-200 shadow-sm hover:shadow-md">
                æˆ‘æ˜¯ç®¡ç†å‘˜ Â· Admin
              </button>
            </div>
          </div>

          <div class="mt-5 text-xs text-slate-500">
            æç¤ºï¼šç®¡ç†å‘˜å…¥å£éœ€è¦å¯†ç éªŒè¯ï¼ˆå†…ç½®ï¼š123456ï¼‰ã€‚
          </div>
        </div>

        <div class="lg:col-span-5 appear-up" style="animation-delay:.06s;">
          <div class="glass card rounded-3xl p-6 h-full flex flex-col">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-slate-500">Todayâ€™s quote</div>
                <div class="font-semibold">â€œMake every room matter.â€</div>
              </div>
              <!-- âœ… ä¿®å¤ç‚¹ï¼šä¸å†ç”¨ Jinja çš„ dateï¼Œæ”¹ä¸º JS æ³¨å…¥ -->
              <div id="day-of-year" class="text-xs px-3 py-1 rounded-full bg-white/70 border border-slate-200">
                Day --/365
              </div>
            </div>

            <!-- Weather Card (Welcome right side) -->
            <div class="mt-5 rounded-2xl bg-gradient-to-br from-slate-900 to-slate-800 text-white p-6 relative overflow-hidden shadow-xl">
              <div class="absolute inset-0 opacity-25"
                   style="background:radial-gradient(600px circle at 20% 10%, rgba(99,102,241,.65), transparent 45%),
                          radial-gradient(500px circle at 90% 30%, rgba(236,72,153,.55), transparent 45%);">
              </div>
              <div class="relative">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-xs text-white/70">Weather Â· Guangdong</div>
                    <div class="text-2xl font-black tracking-tight mt-1">
                      ä½›å±± <span class="text-white/70 text-base font-semibold">Foshan</span>
                    </div>
                    <div class="text-white/70 mt-1 text-sm">å‡ºè¡Œæé†’ Â· Campus vibe</div>
                  </div>
                  <div id="weather-badge" class="text-xs px-3 py-1 rounded-full bg-white/15 border border-white/20">
                    Loading...
                  </div>
                </div>

                <div class="mt-4 grid grid-cols-3 gap-3">
                  <div class="rounded-2xl bg-white/10 border border-white/10 p-3">
                    <div class="text-xs text-white/70">æ¸©åº¦</div>
                    <div class="text-xl font-black mt-1"><span id="weather-temp">--</span>Â°C</div>
                  </div>
                  <div class="rounded-2xl bg-white/10 border border-white/10 p-3">
                    <div class="text-xs text-white/70">é£é€Ÿ</div>
                    <div class="text-xl font-black mt-1"><span id="weather-wind">--</span> km/h</div>
                  </div>
                  <div class="rounded-2xl bg-white/10 border border-white/10 p-3">
                    <div class="text-xs text-white/70">æ—¶é—´</div>
                    <div class="text-sm font-semibold mt-1" id="weather-time">--</div>
                  </div>
                </div>

                <div class="mt-4 text-xs text-white/70">
                  æ•°æ®æºï¼šåç«¯ /api/weatherï¼ˆå¤±è´¥è‡ªåŠ¨é™çº§æç¤ºï¼‰
                </div>
              </div>
            </div>

            <!-- Room Usage (Simple Bars) -->
            <div class="mt-4 rounded-2xl bg-white/60 border border-slate-200 p-5">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-slate-500">Mini chart</div>
                  <div class="mt-1 font-semibold">æœ¬å‘¨è¯¾å®¤ä½¿ç”¨æ¬¡æ•° Â· Room Usage</div>
                </div>
                <button class="btn px-3 py-1.5 rounded-xl bg-white/80 border border-slate-200 text-xs font-semibold"
                        onclick="loadRoomUsage()">
                  åˆ·æ–°
                </button>
              </div>

              <div class="mt-3 text-xs text-slate-500" id="room-usage-meta">
                Loading...
              </div>

              <div class="mt-4 space-y-3" id="room-usage-bars">
                <!-- bars injected by JS -->
              </div>

              <div class="mt-4 text-xs text-slate-500">
                æ•°æ®æºï¼š/api/stats/room_usageï¼ˆåªåšæœ€ç®€å¯è§†åŒ–ï¼Œä¸å½±å“é¢„çº¦åŠŸèƒ½ï¼‰
              </div>
            </div>

            <!-- keep original preview card exactly (unchanged) -->
            <div class="mt-4 rounded-2xl bg-gradient-to-br from-slate-900 to-slate-800 text-white p-6 relative overflow-hidden shadow-xl">
              <div class="absolute inset-0 opacity-25"
                   style="background:radial-gradient(600px circle at 20% 10%, rgba(99,102,241,.65), transparent 45%),
                          radial-gradient(500px circle at 90% 30%, rgba(236,72,153,.55), transparent 45%);">
              </div>
              <div class="relative">
                <div class="text-xs text-white/70">Preview</div>
                <div class="text-2xl font-black tracking-tight mt-1">èµ„æºçœ‹æ¿ Dashboard</div>
                <div class="text-white/70 mt-2 text-sm">
                  æˆ¿é—´ Ã— æ—¥æœŸ Ã— èŠ‚æ¬¡ = ä¸€çœ¼æŒæ§å¯ç”¨æ€§ã€‚
                </div>
              </div>
            </div>

            <!-- original Design system card (unchanged) -->
            <div class="mt-4 flex-1 rounded-2xl bg-white/60 border border-slate-200 p-5">
              <div class="text-xs text-slate-500">Design system</div>
              <div class="mt-1 font-semibold">Glass Â· Rounded Â· Micro-interactions</div>
              <div class="mt-2 text-sm text-slate-600">
                æŠ½å±‰å¼å®¡æ ¸ã€Toast é€šçŸ¥ã€è¯¾å®¤åˆ—æœç´¢ç­›é€‰ã€‚
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-10 text-xs text-slate-500 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
        <div>Â© SCNU IBC SAC Â· Smart Booking System</div>
        <div class="flex gap-2">
          <span class="px-3 py-1 rounded-full glass">Bilingual</span>
          <span class="px-3 py-1 rounded-full glass">High-end UI</span>
        </div>
      </div>
    </div>
  </div>

  <!-- App Shell -->
  <div id="app-shell" class="hidden">
    <header class="sticky top-0 z-40">
      <div class="mx-auto max-w-[1600px] px-5 pt-5">
        <div class="glass card rounded-3xl px-5 py-4 flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-indigo-600 to-pink-500 shadow-lg shadow-indigo-600/20 grid place-items-center text-white font-black">
              IBC
            </div>
            <div class="leading-tight">
              <div class="text-lg font-bold tracking-tight">è¯¾å®¤èµ„æºçœ‹æ¿ Â· Dashboard</div>
              <div class="text-xs text-slate-500">SCNU IBC SAC Â· Smart Classroom Booking</div>
            </div>
          </div>

          <div class="flex flex-col sm:flex-row sm:items-center gap-2">
            <div class="flex items-center gap-2">
              <a href="/?view_date={{ prev_week }}{{ '&role=admin' if request.query_params.get('role')=='admin' else '' }}"
                 class="btn px-4 py-2 rounded-2xl bg-white/70 border border-slate-200 hover:shadow-md text-sm">
                â† ä¸Šå‘¨
              </a>
              <div class="px-4 py-2 rounded-2xl bg-slate-900 text-white text-sm font-semibold shadow-sm">
                {{ current_week_start }} è‡³ {{ next_week }}
              </div>
              <a href="/?view_date={{ next_week }}{{ '&role=admin' if request.query_params.get('role')=='admin' else '' }}"
                 class="btn px-4 py-2 rounded-2xl bg-white/70 border border-slate-200 hover:shadow-md text-sm">
                ä¸‹å‘¨ â†’
              </a>
            </div>

            <div class="flex items-center gap-2 sm:pl-2">
              <span class="text-sm font-semibold text-slate-700">èº«ä»½</span>
              <select id="role-switch" onchange="handleRoleChange()"
                      class="px-4 py-2 rounded-2xl bg-white/80 border border-slate-200 text-sm font-semibold text-slate-800 shadow-sm hover:shadow-md focus:outline-none focus:ring-4 focus:ring-indigo-200/50">
                <option value="student">å­¦ç”Ÿ Â· Student</option>
                <option value="admin">ç®¡ç†å‘˜ Â· Admin</option>
              </select>
            </div>
          </div>
        </div>

        <!-- âœ… å‡çº§ï¼šè¯¾å®¤æœç´¢ç­›é€‰ï¼ˆéšè—åˆ—ï¼Œä¸æ”¹åç«¯ï¼‰ -->
        <div class="mt-4 grid grid-cols-1 lg:grid-cols-12 gap-4">
          <div class="lg:col-span-8 glass card rounded-3xl p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="flex flex-wrap items-center gap-2 text-sm">
              <span class="px-3 py-1 rounded-full bg-emerald-500/15 text-emerald-700 border border-emerald-600/20">å¯é¢„çº¦ FREE</span>
              <span class="px-3 py-1 rounded-full bg-rose-500/15 text-rose-700 border border-rose-600/20">è¯¾ç¨‹/å ç”¨ COURSE</span>
              <span class="px-3 py-1 rounded-full bg-amber-500/15 text-amber-800 border border-amber-600/20">å·²é¢„çº¦ TAKEN</span>
              <span class="px-3 py-1 rounded-full bg-slate-500/15 text-slate-700 border border-slate-600/20">å¾…å®¡æ ¸ PENDING</span>
              <span class="px-3 py-1 rounded-full bg-indigo-500/12 text-indigo-700 border border-indigo-600/15">å‘¨æ—¥ SUNDAY</span>
            </div>

            <div class="flex items-center gap-2">
              <input id="room-filter"
                     class="w-64 max-w-full rounded-2xl border border-slate-200 bg-white/80 px-4 py-2 text-sm
                            focus:outline-none focus:ring-4 focus:ring-indigo-200/40"
                     placeholder="ç­›é€‰è¯¾å®¤ï¼ˆè¾“å…¥å…³é”®å­—ï¼‰"
                     oninput="filterRoomColumns(this.value)">
              <button class="btn px-4 py-2 rounded-2xl bg-white/70 border border-slate-200 hover:shadow-md text-sm"
                      onclick="resetRoomFilter()">
                é‡ç½®
              </button>
            </div>
          </div>

          <div class="lg:col-span-4 grid grid-cols-2 gap-4">
            <div class="glass card rounded-3xl p-4">
              <div class="text-xs text-slate-500">å¾…å®¡æ ¸ Pending</div>
              <div class="text-2xl font-black tracking-tight mt-1">{{ pending_list|length }}</div>
              <div class="text-xs text-slate-500 mt-1">Admin drawer</div>
            </div>
            <div class="glass card rounded-3xl p-4">
              <div class="text-xs text-slate-500">å·²é€šè¿‡ Approved</div>
              <div class="text-2xl font-black tracking-tight mt-1">{{ approved_list|length }}</div>
              <div class="text-xs text-slate-500 mt-1">History list</div>
            </div>
          </div>
        </div>

      </div>
    </header>

    <main class="mx-auto max-w-[1600px] px-5 pb-10 pt-6">
      <div class="glass card rounded-3xl p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="font-bold text-slate-800">èµ„æºçŸ©é˜µ Â· Availability Matrix</div>
          <div class="text-xs text-slate-500">è¾“å…¥ç­›é€‰åªéšè—è¯¾å®¤åˆ—ï¼Œä¸å½±å“æ•°æ®</div>
        </div>

        <div class="overflow-auto rounded-2xl border border-slate-200/60 bg-white/70">
          <table id="matrix-table" class="min-w-full border-separate border-spacing-2 text-sm text-center">
            <thead class="sticky top-0 z-10">
              <tr class="text-white">
                <th class="p-3 rounded-2xl bg-slate-900/95">å‘¨æ¬¡</th>
                <th class="p-3 rounded-2xl bg-slate-900/95">æ—¥æœŸ</th>
                <th class="p-3 rounded-2xl bg-slate-900/95">æ˜ŸæœŸ</th>
                <th class="p-3 rounded-2xl bg-slate-900/95">èŠ‚æ¬¡</th>
                {% for room in rooms %}
                  <!-- âœ… ç»™æ¯ä¸ªæˆ¿é—´åˆ—ä¸€ä¸ªå¯å®šä½çš„å±æ€§ -->
                  <th class="p-3 rounded-2xl bg-slate-900/95 min-w-[200px] room-col-head"
                      data-room-name="{{ room.name }}">
                    {{ room.name }}
                  </th>
                {% endfor %}
              </tr>
            </thead>

            <tbody class="align-middle">
              {% for row in dashboard_rows %}
              <tr>
                <td class="p-3 rounded-2xl bg-slate-50 border border-slate-200/70 font-semibold">{{ row.week }}</td>
                <td class="p-3 rounded-2xl bg-slate-50 border border-slate-200/70 font-semibold">{{ row.date }}</td>
                <td class="p-3 rounded-2xl bg-slate-50 border border-slate-200/70 font-bold {{ 'text-indigo-700' if row.is_sunday else 'text-slate-700' }}">
                  {{ row.weekday }}
                </td>
                <td class="p-3 rounded-2xl bg-slate-50 border border-slate-200/70 text-slate-700">{{ row.slot }}</td>

                {% for cell in row.cells %}
                <td
                  class="cell p-3 border border-slate-200/60 min-h-[64px] room-col-cell
                    {% if cell.status == 'FREE' %} cell-free
                    {% elif cell.status == 'SUNDAY' %} cell-sunday
                    {% elif cell.status == 'COURSE' %} cell-course
                    {% elif cell.status == 'TAKEN' %} cell-taken
                    {% else %} cell-pending {% endif %}"
                  data-status="{{ cell.status }}"
                  data-room-id="{{ cell.room_id }}"
                  data-date="{{ row.date }}"
                  data-slot="{{ row.slot }}"
                  data-booking-id="{{ cell.booking.id if cell.booking else '' }}"
                  data-student="{{ cell.booking.student_name if cell.booking else '' }}"
                  data-student-id="{{ cell.booking.student_id if cell.booking else '' }}"
                  data-email="{{ cell.booking.student_email if cell.booking else '' }}"
                  data-teacher="{{ cell.booking.instructor_name if cell.booking else '' }}"
                  data-purpose="{{ cell.booking.purpose if cell.booking else '' }}"
                  onclick="handleCellClick(this)"
                  onmousemove="setCellSpotlight(event, this)"
                >
                  {% if cell.status == 'COURSE' %}
                    <div class="font-extrabold">{{ cell.booking.student_name }}</div>
                    <div class="text-xs opacity-80 mt-1">{{ cell.booking.instructor_name }}</div>
                  {% elif cell.status == 'TAKEN' %}
                    <div class="font-bold">å·²é¢„çº¦</div>
                    <div class="text-xs text-slate-700/70 mt-1">{{ cell.booking.student_name }}</div>
                  {% elif cell.status == 'PENDING' %}
                    <div class="font-bold text-slate-700/80">å®¡æ ¸ä¸­</div>
                    <div class="text-xs text-slate-500 mt-1">Waiting</div>
                  {% elif cell.status == 'FREE' %}
                    <div class="flex items-center justify-center gap-2">
                      <span class="inline-flex items-center justify-center w-7 h-7 rounded-full bg-emerald-500/15 border border-emerald-600/20 text-emerald-700 font-black">+</span>
                      <span class="text-xs text-slate-700 font-semibold opacity-80">Click</span>
                    </div>
                  {% else %}
                    <div class="text-slate-600/80 text-xs">â€”</div>
                  {% endif %}
                </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Admin Floating -->
    <button onclick="toggleDrawer()"
            class="admin-only hidden fixed bottom-7 right-7 z-50 btn rounded-2xl px-5 py-4 text-white font-bold
                   bg-gradient-to-r from-indigo-600 to-pink-500 shadow-xl shadow-indigo-600/20 flex items-center gap-3">
      <span class="text-lg">ç®¡ç†ç”³è¯·</span>
      <span class="px-2 py-1 rounded-full bg-white/20 border border-white/20 text-sm">
        {{ pending_list|length }}
      </span>
    </button>

    <!-- Drawer -->
    <aside id="audit-drawer" class="drawer fixed inset-y-0 right-0 w-[420px] bg-white z-[60] border-l border-slate-200 shadow-2xl overflow-y-auto">
      <div class="sticky top-0 bg-white/80 backdrop-blur border-b border-slate-200 p-5 flex items-center justify-between">
        <div>
          <div class="text-xs text-slate-500">Admin Center</div>
          <div class="text-xl font-black tracking-tight">é¢„çº¦ç®¡ç†ä¸­å¿ƒ</div>
        </div>
        <button onclick="toggleDrawer()" class="btn w-10 h-10 rounded-2xl bg-slate-100 hover:bg-rose-50 hover:text-rose-600 grid place-items-center text-xl">&times;</button>
      </div>

      <div class="p-5">
        <div class="grid grid-cols-2 gap-2 mb-4">
          <button onclick="showTab('pending')" id="btn-pending"
                  class="btn rounded-2xl py-3 font-bold border border-indigo-200 bg-indigo-50 text-indigo-700">
            å¾…å®¡æ ¸ ({{ pending_list|length }})
          </button>
          <button onclick="showTab('approved')" id="btn-approved"
                  class="btn rounded-2xl py-3 font-bold border border-slate-200 bg-white text-slate-600">
            å·²é€šè¿‡ ({{ approved_list|length }})
          </button>
        </div>

        <!-- Pending -->
        <div id="tab-pending" class="space-y-4">
          {% for item in pending_list %}
          <div class="card rounded-3xl p-4 bg-white border border-slate-200/70 hover:shadow-lg transition">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-lg font-black">{{ item.student_name }}</div>
                <div class="text-xs text-slate-500">å­¦å·: {{ item.student_id }}</div>
              </div>
              <div class="text-xs px-3 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-600">
                {{ item.created_at.strftime('%m-%d %H:%M') }}
              </div>
            </div>

            <!-- âœ… å‡çº§ï¼šæ˜¾ç¤ºçœŸå®è¯¾å®¤åï¼ˆBooking.room relationshipï¼‰ -->
            <div class="mt-3 rounded-2xl bg-slate-50 border border-slate-200/60 p-3 text-sm text-slate-700 space-y-1">
              <div><span class="font-semibold">è¯¾å®¤:</span>
                {{ item.room.name if item.room else ("Room " ~ item.room_id) }}
              </div>
              <div><span class="font-semibold">æ—¶é—´:</span> {{ item.booking_date }} | {{ item.slot }}</div>
              <div><span class="font-semibold">é‚®ç®±:</span> {{ item.student_email }}</div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2">
              <form action="/audit/{{ item.id }}" method="post">
                <input type="hidden" name="action" value="approve">
                <button class="btn w-full rounded-2xl py-3 font-bold text-white bg-emerald-600 hover:bg-emerald-700 shadow-sm">
                  é€šè¿‡
                </button>
              </form>
              <button onclick="openCancelModal('{{ item.id }}', 'reject', 'reject')"
                      class="btn w-full rounded-2xl py-3 font-bold text-white bg-rose-600 hover:bg-rose-700 shadow-sm">
                é©³å›
              </button>
            </div>
          </div>
          {% else %}
          <div class="text-center py-10 text-slate-400">
            <div class="text-lg font-semibold">æš‚æ— å¾…å®¡æ ¸ç”³è¯·</div>
            <div class="text-xs mt-1">No pending requests</div>
          </div>
          {% endfor %}
        </div>

        <!-- Approved -->
        <div id="tab-approved" class="space-y-4 hidden">
          {% for item in approved_list %}
          <div class="card rounded-3xl p-4 bg-white border border-slate-200/70">
            <div class="flex items-center justify-between">
              <div class="font-black text-slate-800">
                {% if item.booking_type == 'course' %}
                  ğŸ“˜ [è¯¾ç¨‹] {{ item.student_name }}
                {% else %}
                  ğŸ‘¤ {{ item.student_name }} ({{ item.student_id }})
                {% endif %}
              </div>
            </div>

            <!-- âœ… å‡çº§ï¼šæ˜¾ç¤ºçœŸå®è¯¾å®¤å -->
            <div class="mt-3 text-sm text-slate-700 space-y-1">
              <div><span class="font-semibold">æ—¶é—´:</span> {{ item.booking_date }} Â· {{ item.slot }}</div>
              <div><span class="font-semibold">ä½ç½®:</span>
                {{ item.room.name if item.room else ("Room " ~ item.room_id) }}
              </div>
            </div>

            {% if item.booking_type == 'course' %}
              <button onclick="openCancelModal('{{ item.id }}', 'delete', 'course_delete')"
                      class="btn w-full mt-4 rounded-2xl py-2.5 font-bold bg-slate-100 border border-slate-200 text-slate-700 hover:bg-rose-50 hover:text-rose-700">
                å–æ¶ˆæ’è¯¾
              </button>
            {% else %}
              <button onclick="openCancelModal('{{ item.id }}', 'delete', 'student_delete')"
                      class="btn w-full mt-4 rounded-2xl py-2.5 font-bold bg-slate-100 border border-slate-200 text-slate-700 hover:bg-rose-50 hover:text-rose-700">
                å¼ºåˆ¶å–æ¶ˆ
              </button>
            {% endif %}
          </div>
          {% else %}
          <div class="text-center py-10 text-slate-400">
            <div class="text-lg font-semibold">æš‚æ— è®°å½•</div>
            <div class="text-xs mt-1">No approved records</div>
          </div>
          {% endfor %}
        </div>

      </div>
    </aside>

    <!-- Cancel Modal -->
    <div id="cancel-modal" class="fixed inset-0 z-[65] hidden">
      <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('cancel-modal')"></div>
      <div class="relative h-full w-full grid place-items-center p-4">
        <div class="appear card w-full max-w-md rounded-3xl bg-white p-6 border border-slate-200">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-xs text-slate-500">Confirm</div>
              <h2 class="text-xl font-black" id="cancel-title">ç¡®è®¤æ“ä½œ</h2>
            </div>
            <button class="btn w-10 h-10 rounded-2xl bg-slate-100 hover:bg-rose-50 hover:text-rose-600 grid place-items-center text-xl"
                    onclick="closeModal('cancel-modal')">&times;</button>
          </div>

          <form id="cancel-form" action="" method="post" class="mt-5">
            <input type="hidden" name="action" id="cancel-action-input">
            <label class="block text-sm font-bold text-slate-700 mb-2">è¯·é€‰æ‹©åŸå› </label>
            <select name="cancel_reason" id="cancel-reason-select"
                    class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-rose-200/40">
            </select>

            <div class="mt-6 flex justify-end gap-2">
              <button type="button" class="btn px-4 py-2.5 rounded-2xl bg-slate-100 border border-slate-200"
                      onclick="closeModal('cancel-modal')">æš‚ä¸æ“ä½œ</button>
              <button type="submit" class="btn px-4 py-2.5 rounded-2xl bg-rose-600 text-white font-bold hover:bg-rose-700 shadow-sm">
                ç¡®è®¤æäº¤
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 z-[65] hidden">
      <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('detail-modal')"></div>
      <div class="relative h-full w-full grid place-items-center p-4">
        <div class="appear card w-full max-w-md rounded-3xl bg-white p-6 border border-slate-200">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-xs text-slate-500">Record</div>
              <div class="text-xl font-black">é¢„çº¦è¯¦ç»†æ¡£æ¡ˆ</div>
            </div>
            <button class="btn w-10 h-10 rounded-2xl bg-slate-100 hover:bg-rose-50 hover:text-rose-600 grid place-items-center text-xl"
                    onclick="closeModal('detail-modal')">&times;</button>
          </div>

          <div class="mt-5 space-y-3 text-sm">
            <div class="rounded-2xl bg-slate-50 border border-slate-200/60 p-4">
              <div class="text-xs text-slate-500">ç”³è¯·äºº/è¯¾ç¨‹</div>
              <div id="detail-name" class="text-lg font-black mt-1"></div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div class="rounded-2xl bg-white border border-slate-200/60 p-4">
                <div class="text-xs text-slate-500">å­¦å·/ID</div>
                <div id="detail-student-id" class="font-semibold mt-1"></div>
              </div>
              <div class="rounded-2xl bg-white border border-slate-200/60 p-4">
                <div class="text-xs text-slate-500">ä»»è¯¾/æŒ‡å¯¼è€å¸ˆ</div>
                <div id="detail-teacher" class="font-semibold mt-1"></div>
              </div>
            </div>

            <div class="rounded-2xl bg-white border border-slate-200/60 p-4">
              <div class="text-xs text-slate-500">è”ç³»é‚®ç®±</div>
              <div id="detail-email" class="font-semibold mt-1 text-indigo-700"></div>
            </div>

            <div class="rounded-2xl bg-white border border-slate-200/60 p-4">
              <div class="text-xs text-slate-500">ç”¨é€”</div>
              <div id="detail-purpose" class="font-semibold mt-1"></div>
            </div>

            <div class="text-xs text-slate-500 pt-2 border-t border-slate-200">
              æ—¶é—´: <span id="detail-time" class="font-semibold text-slate-700"></span>
            </div>
          </div>

          <div class="mt-6 flex justify-end gap-2">
            <button type="button" class="btn px-4 py-2.5 rounded-2xl bg-slate-100 border border-slate-200"
                    onclick="closeModal('detail-modal')">å…³é—­</button>
            <button id="btn-force-cancel"
                    class="btn px-4 py-2.5 rounded-2xl bg-rose-600 text-white font-bold hover:bg-rose-700 shadow-sm">
              å¼ºåˆ¶å–æ¶ˆ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Student Modal -->
    <div id="student-modal" class="fixed inset-0 z-[65] hidden">
      <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('student-modal')"></div>
      <div class="relative h-full w-full grid place-items-center p-4">
        <div class="appear card w-full max-w-lg rounded-3xl bg-white p-6 border border-slate-200">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-xs text-slate-500">Student</div>
              <div class="text-xl font-black text-indigo-700">å­¦ç”Ÿé¢„çº¦ç”³è¯·</div>
            </div>
            <button class="btn w-10 h-10 rounded-2xl bg-slate-100 hover:bg-rose-50 hover:text-rose-600 grid place-items-center text-xl"
                    onclick="closeModal('student-modal')">&times;</button>
          </div>

          <form action="/submit_booking" method="post" class="mt-5">
            <input type="hidden" name="mode" value="student">
            <input type="hidden" name="room_id" id="stu-room-id">
            <input type="hidden" name="booking_date" id="stu-date">
            <input type="hidden" name="slot" id="stu-slot">

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">å­¦å·</label>
                <input type="text" name="student_id" required
                       class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-indigo-200/40"
                       placeholder="Student ID">
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">å§“å</label>
                <input type="text" name="student_name" required
                       class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-indigo-200/40"
                       placeholder="Name">
              </div>
            </div>

            <div class="mt-3">
              <label class="block text-sm font-bold text-slate-700 mb-1">æŒ‡å¯¼è€å¸ˆï¼ˆå¯é€‰ï¼‰</label>
              <input type="text" name="instructor_name"
                     class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-indigo-200/40"
                     placeholder="Instructor">
            </div>

            <div class="mt-3">
              <label class="block text-sm font-bold text-slate-700 mb-1">è”ç³»é‚®ç®±</label>
              <input type="email" name="student_email" required
                     class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-indigo-200/40"
                     placeholder="Email">
            </div>

            <div class="mt-3">
              <label class="block text-sm font-bold text-slate-700 mb-1">ç”³è¯·ç”¨é€”</label>
              <input type="text" name="purpose" required
                     class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-indigo-200/40"
                     placeholder="Purpose">
            </div>

            <div class="mt-6 flex justify-end gap-2">
              <button type="button"
                      class="btn px-4 py-2.5 rounded-2xl bg-slate-100 border border-slate-200"
                      onclick="closeModal('student-modal')">å–æ¶ˆ</button>
              <button type="submit"
                      class="btn px-4 py-2.5 rounded-2xl bg-gradient-to-r from-indigo-600 to-pink-500 text-white font-bold shadow-lg shadow-indigo-600/20">
                æäº¤ç”³è¯·
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Admin Course Modal -->
    <div id="admin-modal" class="fixed inset-0 z-[65] hidden">
      <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('admin-modal')"></div>
      <div class="relative h-full w-full grid place-items-center p-4">
        <div class="appear card w-full max-w-2xl rounded-3xl bg-white p-6 border border-slate-200">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-xs text-slate-500">Admin</div>
              <div class="text-xl font-black text-rose-700">ç®¡ç†å‘˜æ’è¯¾ï¼ˆæ‰¹é‡ï¼‰</div>
            </div>
            <button class="btn w-10 h-10 rounded-2xl bg-slate-100 hover:bg-rose-50 hover:text-rose-600 grid place-items-center text-xl"
                    onclick="closeModal('admin-modal')">&times;</button>
          </div>

          <form action="/submit_booking" method="post" class="mt-5">
            <input type="hidden" name="mode" value="course">
            <input type="hidden" name="room_id" id="adm-room-id">
            <input type="hidden" name="booking_date" id="adm-date">

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">è¯¾ç¨‹åç§°</label>
                <input type="text" name="course_name" required
                       class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-rose-200/40"
                       placeholder="å¦‚ï¼šPythonç¨‹åºè®¾è®¡">
              </div>
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-1">ä»»è¯¾è€å¸ˆ</label>
                <input type="text" name="course_teacher" required
                       class="w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-rose-200/40"
                       placeholder="å¦‚ï¼šç‹è€å¸ˆ">
              </div>
            </div>

            <div class="mt-4 rounded-3xl border border-rose-200 bg-rose-50 p-4">
              <div class="font-bold text-rose-900 text-sm">å¾ªç¯ä¸Šè¯¾å‘¨æ¬¡ï¼ˆé»˜è®¤ 1-16 å‘¨ï¼‰</div>
              <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
                <span>ç¬¬</span>
                <input type="number" name="start_week" value="1" min="1" max="20"
                       class="w-20 rounded-2xl border border-rose-200 bg-white px-3 py-2 text-center font-semibold focus:outline-none focus:ring-4 focus:ring-rose-200/40">
                <span>å‘¨ è‡³ ç¬¬</span>
                <input type="number" name="end_week" value="16" min="1" max="20"
                       class="w-20 rounded-2xl border border-rose-200 bg-white px-3 py-2 text-center font-semibold focus:outline-none focus:ring-4 focus:ring-rose-200/40">
                <span>å‘¨</span>
              </div>
            </div>

            <div class="mt-4">
              <div class="font-bold text-sm text-slate-700 mb-2">é€‰æ‹©ä¸Šè¯¾èŠ‚æ¬¡</div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 rounded-3xl border border-slate-200 bg-slate-50 p-3">
                {% for s in slots_list %}
                <label class="btn flex items-center gap-3 rounded-2xl bg-white border border-slate-200 px-3 py-2 hover:shadow-sm cursor-pointer">
                  <input type="checkbox" name="slot" value="{{ s.value }}" class="w-5 h-5 accent-rose-600">
                  <span class="text-sm font-semibold text-slate-800">{{ s.value }}</span>
                </label>
                {% endfor %}
              </div>
            </div>

            <div class="mt-6 flex justify-end gap-2">
              <button type="button"
                      class="btn px-4 py-2.5 rounded-2xl bg-slate-100 border border-slate-200"
                      onclick="closeModal('admin-modal')">å–æ¶ˆ</button>
              <button type="submit"
                      class="btn px-4 py-2.5 rounded-2xl bg-rose-600 text-white font-bold hover:bg-rose-700 shadow-sm">
                ç¡®è®¤æ·»åŠ 
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 z-[75] hidden">
      <div class="absolute inset-0 bg-slate-950/70 backdrop-blur-sm" onclick="cancelLogin()"></div>
      <div class="relative h-full w-full grid place-items-center p-4">
        <div class="appear card w-full max-w-md rounded-3xl bg-white p-7 border border-slate-200 text-center">
          <div class="mx-auto w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-600 to-pink-500 text-white font-black grid place-items-center shadow-lg shadow-indigo-600/20">
            ğŸ”
          </div>
          <div class="mt-4 text-xs text-slate-500">Admin Verification</div>
          <div class="text-xl font-black mt-1">ç®¡ç†å‘˜ç™»å½•</div>

          <input type="password" id="admin-password-input"
                 class="mt-5 w-full rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-center text-lg tracking-widest
                        focus:outline-none focus:ring-4 focus:ring-indigo-200/40"
                 placeholder="è¯·è¾“å…¥å¯†ç  (123456)"
                 onkeydown="if(event.key === 'Enter') verifyPassword()">

          <div class="mt-5 flex justify-center gap-2">
            <button onclick="cancelLogin()"
                    class="btn px-6 py-2.5 rounded-2xl bg-slate-100 border border-slate-200 font-semibold">
              å–æ¶ˆ
            </button>
            <button onclick="verifyPassword()"
                    class="btn px-6 py-2.5 rounded-2xl bg-gradient-to-r from-indigo-600 to-pink-500 text-white font-bold shadow-lg shadow-indigo-600/20">
              ç™»å½•
            </button>
          </div>

          <div class="mt-4 text-xs text-slate-500">
            ä»…ç”¨äºè¿›å…¥ç®¡ç†å‘˜å®¡æ ¸/æ’è¯¾ç•Œé¢ï¼ˆç³»ç»Ÿå†…ç½®å¯†ç ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    let isAdminLoggedIn = false;

    function toast(type, title, desc){
      const root = document.getElementById('toast-root');
      const el = document.createElement('div');

      const palette = {
        success: "border-emerald-200 bg-emerald-50 text-emerald-900",
        info: "border-indigo-200 bg-indigo-50 text-indigo-900",
        warning: "border-amber-200 bg-amber-50 text-amber-950",
        error: "border-rose-200 bg-rose-50 text-rose-900"
      }[type] || "border-slate-200 bg-white text-slate-900";

      el.className = `toast-enter card rounded-2xl border ${palette} px-4 py-3 shadow-lg max-w-sm`;
      el.innerHTML = `
        <div class="flex items-start gap-3">
          <div class="mt-0.5 w-2.5 h-2.5 rounded-full ${type==='success'?'bg-emerald-500':type==='error'?'bg-rose-500':type==='warning'?'bg-amber-500':'bg-indigo-500'}"></div>
          <div class="flex-1">
            <div class="font-bold text-sm">${title}</div>
            ${desc ? `<div class="text-xs opacity-80 mt-0.5 leading-relaxed">${desc}</div>` : ``}
          </div>
          <button class="ml-2 text-lg leading-none opacity-60 hover:opacity-100">&times;</button>
        </div>
      `;
      el.querySelector('button').onclick = () => removeToast(el);
      root.appendChild(el);
      setTimeout(()=>removeToast(el), 3200);
    }
    function removeToast(el){
      if(!el) return;
      el.classList.remove('toast-enter');
      el.classList.add('toast-exit');
      setTimeout(()=>{ try{ el.remove(); }catch(e){} }, 220);
    }

    function setCellSpotlight(e, el){
      const r = el.getBoundingClientRect();
      const mx = ((e.clientX - r.left) / r.width) * 100;
      const my = ((e.clientY - r.top) / r.height) * 100;
      el.style.setProperty('--mx', mx + '%');
      el.style.setProperty('--my', my + '%');
    }

    function showWelcome(){
      document.getElementById('welcome-screen').classList.remove('hidden');
      document.getElementById('app-shell').classList.add('hidden');
    }
    function hideWelcome(){
      document.getElementById('welcome-screen').classList.add('hidden');
      document.getElementById('app-shell').classList.remove('hidden');
    }

    function setRoleParam(role){
      const url = new URL(window.location.href);
      url.searchParams.set('role', role);
      window.history.replaceState({}, "", url.toString());
    }

    function enterStudentFromWelcome(){
      hideWelcome();
      const roleSelect = document.getElementById('role-switch');
      roleSelect.value = 'student';
      setRoleParam('student');
      updateUIForRole();
      toast('info', 'è¿›å…¥å­¦ç”Ÿç«¯', 'ç‚¹å‡»ç»¿è‰²æ ¼å­å‘èµ·é¢„çº¦ç”³è¯·ã€‚');
    }

    function enterAdminFromWelcome(){
      hideWelcome();
      document.getElementById('password-modal').classList.remove('hidden');
      const inp = document.getElementById('admin-password-input');
      inp.value = '';
      inp.focus();
    }

    function handleRoleChange() {
      const role = document.getElementById('role-switch').value;
      if (role === 'admin') {
        if (!isAdminLoggedIn) {
          document.getElementById('password-modal').classList.remove('hidden');
          const inp = document.getElementById('admin-password-input');
          inp.value = '';
          inp.focus();
          document.getElementById('role-switch').value = 'student';
          toast('warning', 'éœ€è¦ç®¡ç†å‘˜éªŒè¯', 'è¯·è¾“å…¥å¯†ç ä»¥è¿›å…¥å®¡æ ¸/æ’è¯¾ç•Œé¢ã€‚');
        } else {
          setRoleParam('admin');
          updateUIForRole();
          toast('info', 'ç®¡ç†å‘˜æ¨¡å¼', 'ä½ å¯ä»¥æ‰“å¼€å³ä¸‹è§’ç®¡ç†æŠ½å±‰è¿›è¡Œå®¡æ ¸ã€‚');
        }
      } else {
        setRoleParam('student');
        updateUIForRole();
        toast('info', 'å­¦ç”Ÿæ¨¡å¼', 'ç‚¹å‡»ç»¿è‰²æ ¼å­å‘èµ·é¢„çº¦ç”³è¯·ã€‚');
      }
    }

    function verifyPassword() {
      const pwd = document.getElementById('admin-password-input').value;
      const formData = new FormData();
      formData.append('password', pwd);

      fetch('/api/validate_password', { method: 'POST', body: formData })
        .then(r => r.json())
        .then(d => {
          if (d.valid) {
            isAdminLoggedIn = true;
            document.getElementById('password-modal').classList.add('hidden');
            document.getElementById('role-switch').value = 'admin';
            setRoleParam('admin');
            updateUIForRole();
            toast('success', 'éªŒè¯é€šè¿‡', 'å·²è¿›å…¥ç®¡ç†å‘˜ç•Œé¢ã€‚');
          } else {
            toast('error', 'å¯†ç é”™è¯¯', 'è¯·é‡æ–°è¾“å…¥ã€‚');
            const inp = document.getElementById('admin-password-input');
            inp.value = '';
            inp.focus();
          }
        })
        .catch(() => toast('error', 'ç½‘ç»œé”™è¯¯', 'æ— æ³•éªŒè¯ç®¡ç†å‘˜å¯†ç ã€‚'));
    }

    function cancelLogin() {
      document.getElementById('password-modal').classList.add('hidden');
      document.getElementById('role-switch').value = 'student';
      setRoleParam('student');
      updateUIForRole();
    }

    function updateUIForRole() {
      const role = document.getElementById('role-switch').value;
      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = (role === 'admin') ? 'flex' : 'none';
      });
      if(role !== 'admin'){
        document.getElementById('audit-drawer').classList.remove('open');
      }
    }

    function openCancelModal(bookingId, actionType, scenario) {
      document.getElementById('cancel-modal').classList.remove('hidden');
      document.getElementById('cancel-form').action = "/audit/" + bookingId;
      document.getElementById('cancel-action-input').value = actionType;

      const select = document.getElementById('cancel-reason-select');
      const title = document.getElementById('cancel-title');
      select.innerHTML = '';

      let options = [];
      if (scenario === 'reject') {
        title.innerText = "ç¡®è®¤é©³å›ç”³è¯·";
        options = ["æœ¬äººå¡«å†™ä¿¡æ¯æœ‰è¯¯", "é¢„çº¦è¯·æ±‚å’Œå­¦é™¢å…¶å®ƒæ´»åŠ¨å†²çª"];
      } else if (scenario === 'course_delete') {
        title.innerText = "ç¡®è®¤å–æ¶ˆè¯¾ç¨‹";
        options = ["æ•™å¸ˆéœ€è¦è°ƒè¯¾", "ä¸Šè¯¾åœºæ‰€å’Œå…¶å®ƒå®‰æ’å†²çª"];
      } else {
        title.innerText = "ç¡®è®¤å–æ¶ˆé¢„çº¦";
        options = ["æœ¬äººè‡ªæ„¿ç”³è¯·å–æ¶ˆ", "ä¸å…¶å®ƒæ´»åŠ¨è¯¾ç¨‹å†²çª"];
      }
      options.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt;
        o.innerText = opt;
        select.appendChild(o);
      });

      closeModal('detail-modal');
    }

    function handleCellClick(el) {
      const status = el.dataset.status;
      const role = document.getElementById('role-switch').value;
      const bookingId = el.dataset.bookingId;

      if (status === 'SUNDAY') return toast('info', 'å‘¨æ—¥ä¼‘æ¯', 'Sunday off.');

      if (role === 'admin' && (status === 'TAKEN' || status === 'COURSE')) {
        document.getElementById('detail-modal').classList.remove('hidden');
        document.getElementById('detail-name').innerText = el.dataset.student;
        document.getElementById('detail-student-id').innerText = el.dataset.studentId || 'N/A';
        document.getElementById('detail-teacher').innerText = el.dataset.teacher || 'æ— ';
        document.getElementById('detail-email').innerText = el.dataset.email || 'æ— ';
        document.getElementById('detail-purpose').innerText = el.dataset.purpose || 'æ— ';
        document.getElementById('detail-time').innerText = el.dataset.date + " " + el.dataset.slot;

        const isCourse = (status === 'COURSE');
        const scenario = isCourse ? 'course_delete' : 'student_delete';
        document.getElementById('btn-force-cancel').onclick = function() {
          openCancelModal(bookingId, 'delete', scenario);
        };
        return;
      }

      if (role === 'admin') {
        if (status === 'FREE') openAdminModal(el.dataset.roomId, el.dataset.date);
        else if (status === 'PENDING') toast('info', 'å¾…å®¡æ ¸ç”³è¯·', 'è¯·æ‰“å¼€å³ä¸‹è§’ç®¡ç†æŠ½å±‰è¿›è¡Œå®¡æ ¸ã€‚');
        else toast('warning', 'ä¸å¯æ“ä½œ', 'è¯¥æ—¶æ®µå·²è¢«å ç”¨ã€‚');
      } else {
        if (status === 'FREE') openStudentModal(el.dataset.roomId, el.dataset.date, el.dataset.slot);
        else toast('warning', 'è¯¥æ—¶æ®µä¸å¯ç”¨', 'è¯·æ›´æ¢æ—¥æœŸ/èŠ‚æ¬¡æˆ–è¯¾å®¤ã€‚');
      }
    }

    function openStudentModal(r, d, s) {
      document.getElementById('student-modal').classList.remove('hidden');
      document.getElementById('stu-room-id').value = r;
      document.getElementById('stu-date').value = d;
      document.getElementById('stu-slot').value = s;
    }
    function openAdminModal(r, d) {
      document.getElementById('admin-modal').classList.remove('hidden');
      document.getElementById('adm-room-id').value = r;
      document.getElementById('adm-date').value = d;
      document.querySelectorAll('#admin-modal input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function toggleDrawer() { document.getElementById('audit-drawer').classList.toggle('open'); }

    function showTab(tabName) {
      const btnPending = document.getElementById('btn-pending');
      const btnApproved = document.getElementById('btn-approved');
      if (tabName === 'pending') {
        document.getElementById('tab-pending').classList.remove('hidden');
        document.getElementById('tab-approved').classList.add('hidden');
        btnPending.className = "btn rounded-2xl py-3 font-bold border border-indigo-200 bg-indigo-50 text-indigo-700";
        btnApproved.className = "btn rounded-2xl py-3 font-bold border border-slate-200 bg-white text-slate-600";
      } else {
        document.getElementById('tab-pending').classList.add('hidden');
        document.getElementById('tab-approved').classList.remove('hidden');
        btnApproved.className = "btn rounded-2xl py-3 font-bold border border-indigo-200 bg-indigo-50 text-indigo-700";
        btnPending.className = "btn rounded-2xl py-3 font-bold border border-slate-200 bg-white text-slate-600";
      }
    }

    // âœ… å‡çº§ï¼šè¯¾å®¤åˆ—ç­›é€‰ï¼ˆæŒ‰æˆ¿é—´åéšè—åˆ—ï¼‰
    function filterRoomColumns(keyword){
      keyword = (keyword || '').trim().toLowerCase();

      const table = document.getElementById('matrix-table');
      if(!table) return;

      const headCells = Array.from(table.querySelectorAll('thead th'));
      // å‰4åˆ—å›ºå®šï¼šå‘¨æ¬¡/æ—¥æœŸ/æ˜ŸæœŸ/èŠ‚æ¬¡
      const roomHeads = headCells.slice(4);

      roomHeads.forEach((th, idx) => {
        const name = (th.dataset.roomName || th.textContent || '').toLowerCase();
        const show = !keyword || name.includes(keyword);

        // çœŸå®åˆ—ç´¢å¼•ï¼ˆåœ¨ tr é‡Œçš„ä½ç½®ï¼‰
        const colIndex = 4 + idx;

        // header
        th.style.display = show ? '' : 'none';

        // body each row td
        Array.from(table.tBodies[0].rows).forEach(tr => {
          const cell = tr.cells[colIndex];
          if(cell) cell.style.display = show ? '' : 'none';
        });
      });
    }
    function resetRoomFilter(){
      const input = document.getElementById('room-filter');
      if(input) input.value = '';
      filterRoomColumns('');
    }

    // âœ… Day of year ç”¨ JS è®¡ç®—ï¼Œå½»åº•é¿å… Jinja date å˜é‡
    function setDayOfYear(){
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 0);
      const diff = now - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const day = Math.floor(diff / oneDay);
      const el = document.getElementById('day-of-year');
      if(el) el.textContent = `Day ${day}/365`;
    }

    // âœ… Welcome right: fetch weather
    async function loadWeather(){
      const badge = document.getElementById('weather-badge');
      const tempEl = document.getElementById('weather-temp');
      const windEl = document.getElementById('weather-wind');
      const timeEl = document.getElementById('weather-time');

      if(!badge || !tempEl || !windEl || !timeEl) return;

      try{
        badge.textContent = 'Loading...';
        const r = await fetch('/api/weather');
        if(!r.ok) throw new Error('HTTP ' + r.status);
        const d = await r.json();
        if(!d || !d.ok) throw new Error('bad payload');

        tempEl.textContent = (d.temp_c ?? '--');
        windEl.textContent = (d.wind_kmh ?? '--');
        timeEl.textContent = (d.time ?? '--');
        badge.textContent = d.cached ? 'Cached' : 'Online';
      }catch(e){
        badge.textContent = 'Offline';
        tempEl.textContent = '--';
        windEl.textContent = '--';
        timeEl.textContent = '--';
      }
    }

    // âœ… Welcome right: fetch simple usage bars
    async function loadRoomUsage(){
      const meta = document.getElementById('room-usage-meta');
      const root = document.getElementById('room-usage-bars');
      if(!meta || !root) return;

      try{
        meta.textContent = 'Loading...';
        root.innerHTML = '';

        const r = await fetch('/api/stats/room_usage');
        if(!r.ok) throw new Error('HTTP ' + r.status);
        const d = await r.json();
        if(!d || !d.ok) throw new Error('bad payload');

        const labels = d.labels || [];
        const values = d.values || [];
        meta.textContent = `${d.week_start} ~ ${d.week_end}ï¼ˆå‘¨ç»Ÿè®¡ï¼‰`;

        const maxV = Math.max(1, ...values);

        labels.forEach((name, i) => {
          const v = values[i] ?? 0;
          const pct = Math.round((v / maxV) * 100);

          const row = document.createElement('div');
          row.className = 'space-y-1';

          row.innerHTML = `
            <div class="flex items-center justify-between text-xs">
              <div class="font-semibold text-slate-700 truncate pr-2" title="${name}">${name}</div>
              <div class="text-slate-500 font-semibold">${v}</div>
            </div>
            <div class="h-2.5 rounded-full bg-slate-200/70 overflow-hidden">
              <div class="h-full rounded-full bg-gradient-to-r from-indigo-500 to-pink-500" style="width:${pct}%"></div>
            </div>
          `;
          root.appendChild(row);
        });

        if(labels.length === 0){
          meta.textContent = `${d.week_start} ~ ${d.week_end}ï¼ˆæš‚æ— æ•°æ®ï¼‰`;
        }
      }catch(e){
        meta.textContent = 'åŠ è½½å¤±è´¥ï¼ˆåç«¯æœªå¯åŠ¨æˆ–æ¥å£ä¸å¯ç”¨ï¼‰';
        root.innerHTML = `
          <div class="text-sm text-rose-700 font-semibold">æ— æ³•è·å–ç»Ÿè®¡æ•°æ®</div>
          <div class="text-xs text-slate-500 mt-1">è¯·ç¡®è®¤ /api/stats/room_usage å¯è®¿é—®</div>
        `;
      }
    }

    window.onload = function() {
      setDayOfYear();
      loadWeather();
      loadRoomUsage();

      const urlParams = new URLSearchParams(window.location.search);
      const msg = urlParams.get('msg');
      const roleParam = urlParams.get('role');

      if (!roleParam) showWelcome();
      else hideWelcome();

      if (roleParam === 'admin') {
        isAdminLoggedIn = true;
        document.getElementById('role-switch').value = 'admin';
      } else {
        document.getElementById('role-switch').value = 'student';
      }
      updateUIForRole();
      showTab('pending');

      if (msg === 'submitted') toast('success', "ç”³è¯·å·²æäº¤", "è¯·ç­‰å¾…åŠ©ç†å®¡æ ¸ç»“æœï¼ˆå¦‚å¡«å†™é‚®ç®±ï¼Œå®¡æ ¸ç»“æœå°†é‚®ä»¶é€šçŸ¥ï¼‰ã€‚");
      else if (msg === 'audit_done') toast('success', "æ“ä½œå®Œæˆ", "ç³»ç»Ÿå·²å¤„ç†å®¡æ ¸/å–æ¶ˆï¼Œå¹¶åœ¨éœ€è¦æ—¶å‘é€é‚®ä»¶é€šçŸ¥ã€‚");
      else if (msg === 'course_added') toast('success', "è¯¾ç¨‹æ’è¯¾æˆåŠŸ", "è¯¾ç¨‹è®°å½•å·²å†™å…¥ç³»ç»Ÿï¼ˆè¯¾ç¨‹ä¸å‘é€é‚®ä»¶é€šçŸ¥ï¼‰ã€‚");
      else if (msg === 'error_conflict') toast('error', "å†²çªå ç”¨", "è¯¥æ—¶æ®µåˆšåˆšè¢«å ç”¨ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶æ®µæˆ–è¯¾å®¤ã€‚");
    };
  </script>
</body>
</html>
